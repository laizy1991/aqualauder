#{extends 'main.html' /}

#{set 'moreStyles'}
<link rel="stylesheet" href="@{'/public/css/admin-info.css'}">
<link rel="stylesheet" href="@{'/public/css/trumpet.css'}">
#{/set}
<style>
    #fileUploadBox{
        box-shadow: 0px 0px 3px #9d9d9d;
        background: #dedede;
        height: 403px;
        width: 465px;
        overflow-y: scroll;
    }

    #imgSorter .img {
        margin: 15px 5px;
    }

    #imgSorter .img .btn-op {
        background: #adadad;
        opacity: 0.5;
        font-size: 32px;
        width: 32px;
        height: 32px;
        float: left;
        cursor: pointer;
    }

    #imgSorter .img .btn-op:hover {
        background: #6762aa;
    }

    #imgSorter .img .btn-op:active {
        background: #2c2cad;
    }

    #imgSorter .img:first-child .up {
        display: none;
    }

    #imgSorter .img:last-child .down {
        display: none;
    }
</style>
<!-- 页头 begin -->
<div class="main-header">
    <div class="breadcrumb">
        <span class="nolink">编辑商品</span>
    </div>
</div>
<!-- 页头 end -->
<table>
    <tbody>
    <tr>
        <td i="body" class="ui-dialog-body">
            <div i="content" class="ui-dialog-content" id="content:createDialog">
                <div class="dialog dialog-create">
                    <form action="@{ajax.GoodsCtrl.update}" id="update">
                        <input name="goods.id" value="${goods.id}" hidden="hidden">
                        <div class="form-group">
                            <label class="label"><span class="asterisk">*</span>商品名称</label>
                            <div class="col">
                                <input type="text" name="goods.title" value="${goods.title}">
                                <span class="msg error-text">必填项！</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="label"><span class="asterisk">*</span>详细描述</label>
                            <div class="col">
                                <input type="text" name="goods.goodsDesc" value="${goods.goodsDesc}">
                                <span class="msg error-text">必填项！</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="label"><span class="asterisk">*</span>价格(分)</label>
                            <div class="col">
                                <input type="text" name="goods.price" value="${goods.price}">
                                <span class="msg error-text">必填项！</span>
                            </div>
                        </div>
                        <!--<div class="form-group">-->
                            <!--<label class="label"><span class="asterisk">*</span>温馨提示</label>-->
                            <!--<div class="col">-->
                                <!--<input type="text" name="goods.warmPrompt" value="${goods.warmPrompt}">-->
                                <!--<span class="msg error-text">必填项！</span>-->
                            <!--</div>-->
                        <!--</div>-->
                        <div class="form-group">
                            <label class="label"><span class="asterisk">*</span>状态</label>
                            <div class="col">
                                <select id="goodState" name="goods.state">
                                    <option value="0">下架</option>
                                    <option value="1">上架</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col">
                                <div id="addIcon">增加图片</div>
                            </div>
                        </div>
                        #{if goods.goodsStocks.size() > 0}
                        #{list items:goods.goodsStocks, as:'info'}
                        <div>
                            <input type="hidden" value="${info.id}">
                        </div>
                        #{/list}
                        #{/if}
                    </form>
                </div>
            </div>
        </td>
        <td i="body" class="ui-dialog-body ui-dialog-body-thin" style="text-align: left;display: block;">
            <div id="fileUploadBox">
                <div id="imgSorter">

                    #{if goods.goodsIcons.size() > 0 && goods.goodsIcons.get(0) != null}
                        #{list items:goods.goodsIcons, as:'info'}
                        <div class="img">
                            <div class="deleteImg btn-op">×</div>
                            <div class="up btn-op" style="margin-left:5px;font-size: 32px;text-align: center;">↑︎</div>
                            <div class="down btn-op" style="margin-left:5px;font-size: 32px;text-align: center;">↓︎︎</div>
                            <img src="/public/pictures/goods/${info.iconUrl}">
                            <input type="hidden" value="${info.id}">
                        </div>
                    #{/list}
                    #{/if}
                </div>
            </div>
        </td>
    </tr>
    <tr>
        <td i="footer" class="ui-dialog-footer">
            <div i="button" class="ui-dialog-button">
                <button role="submitUpdate" type="button" data-id="保存" autofocus="" class="ui-dialog-autofocus">保存</button>
            </div>
        </td>
    </tr>
    </tbody>
</table>
<iframe id="myIframe" style="display:none;" name="myIframe" style="display:none;">
    <script type="text/javascript">
        window.close();
    </script>
</iframe>
<form style="display:none;" target="myIframe" id="addIconForm" action="@{ajax.GoodsCtrl.addIcon}" method="post" enctype="multipart/form-data">
    <input type="file" name="file" id="selectFile">
    <input name="goods.id" value="${goods.id}">
</form>

#{include file="common/jsinclude.html" /}

#{set 'moreScripts'}

<script>
    var verNum = new Date();
    seajs.config({
        base:"../",
        // 加版本号
        map: [
            [ '.js', '.js?v='+verNum]
        ]
    });
    seajs.use("@{'/public/js/app/modules/goods.js'}");
    $(document).ready(function(){
        var state="${goods.state}";
        $("#goodState").val(state);

        $(document).delegate(".deleteImg" ,"click", function(){
            var data = {};
            data["goodsIcon.id"] = $(this).parent().find("input").val();
            $.post("@{ajax.GoodsCtrl.deleteIcon}", data, function(result) {
                result = JSON.parse(result);
                if(result.success) {
                    window.location.reload();
                }
            });
        });

        $(document).delegate(".up", "click", function(){
            var data = {};
            var current = $(this).parent();
            var target = $(this).parent().prev();
            data["goodsIcon.id"] = current.find("input").val();
            data["nxGoodsIcon.id"] = target.find("input").val();
            $.post("@{ajax.GoodsCtrl.changeIcon}", data, function(result) {
                result = JSON.parse(result);
                if(result.success) {
                    window.location.reload();
                }
            });
        });

        $(document).delegate(".down", "click", function(){
            var data = {};
            var current = $(this).parent();
            var target = $(this).parent().next();
            data["goodsIcon.id"] = current.find("input").val();
            data["nxGoodsIcon.id"] = target.find("input").val();
            $.post("@{ajax.GoodsCtrl.changeIcon}", data, function(result) {
                result = JSON.parse(result);
                if(result.success) {
                    window.location.reload();
                }
            });
        });

        $(document).delegate("#addIcon", "click", function(){
            var form = $("#addIconForm");
            form.find("input").click()
        });

        $(document).delegate("#selectFile", "change", function(){
            var form = $("#addIconForm");
            form.submit();
        });

    });
</script>
#{/set}